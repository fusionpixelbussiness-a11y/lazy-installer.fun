#!/bin/bash

set -e
clear

echo "========================================="
echo "   Ryzo Cloud Pterodactyl Installer"
echo "   Panel + Wings | Ubuntu Only"
echo "   Made by Arnav Sharma"
echo "========================================="
sleep 2

# Root check
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Please run as root"
  exit 1
fi

# OS check
if ! grep -qi ubuntu /etc/os-release; then
  echo "‚ùå This installer supports Ubuntu And Debain only"
  exit 1
fi

# Menu
echo ""
echo "1) Install Pterodactyl Panel"
echo "2) Install Pterodactyl Wings"
echo "3) Install Panel + Wings"
echo "4) Exit"
echo ""
read -p "Select option: " option

case $option in

1)
echo "‚ñ∂ Installing Pterodactyl Panel"
;;

2)
echo "‚ñ∂ Installing Pterodactyl Wings"
;;

3)
echo "‚ñ∂ Installing Panel + Wings"
;;

4)
exit 0
;;

*)
echo "‚ùå Invalid option"
exit 1
;;
esac

# Common packages
apt update -y
apt install -y curl wget sudo unzip tar software-properties-common

# Docker install (for Wings)
install_docker() {
  if ! command -v docker &>/dev/null; then
    echo "üê≥ Installing Docker..."
    curl -fsSL https://get.docker.com | bash
    systemctl enable docker
    systemctl start docker
  fi
}

# Wings install
install_wings() {
  install_docker
  echo "üõ† Installing Wings..."
  mkdir -p /etc/pterodactyl
  curl -L -o /usr/local/bin/wings https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64
  chmod +x /usr/local/bin/wings

cat <<EOF >/etc/systemd/system/wings.service
[Unit]
Description=Pterodactyl Wings
After=docker.service
Requires=docker.service

[Service]
User=root
WorkingDirectory=/etc/pterodactyl
ExecStart=/usr/local/bin/wings
Restart=on-failure
LimitNOFILE=4096

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable wings
  echo "‚úÖ Wings installed"
}

# Panel install
install_panel() {
  echo "üåê Installing Panel..."
  apt install -y nginx mariadb-server redis-server
  apt install -y php8.1 php8.1-cli php8.1-common php8.1-mysql php8.1-gd php8.1-mbstring php8.1-bcmath php8.1-xml php8.1-curl zip unzip

  curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  mkdir -p /var/www/pterodactyl
  cd /var/www/pterodactyl

  curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
  tar -xzf panel.tar.gz
  chmod -R 755 storage/* bootstrap/cache/

  composer install --no-dev --optimize-autoloader

  echo "‚úÖ Panel files installed"
  echo "‚ö†Ô∏è Now configure panel manually:"
  echo "php artisan setup"
}

# Run selection
if [[ "$option" == "1" ]]; then
  install_panel
elif [[ "$option" == "2" ]]; then
  install_wings
elif [[ "$option" == "3" ]]; then
  install_panel
  install_wings
fi

echo ""
echo "üéâ Installation completed"
echo "üëâ Panel needs manual setup (php artisan setup)"
